<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle NPU Waker</title>
    <link rel="icon" href="/static/favicon.ico?v=0.2.0-alpha" type="image/x-icon">
    <link rel="stylesheet" href="/static/vendor/highlightjs/github-dark.min.css?v=0.2.0-alpha">
    <link rel="stylesheet" href="/static/styles.css?v=0.2.0-alpha">
    <link rel="stylesheet" href="/static/vendor/katex.min.css?v=0.2.0-alpha">
</head>
<body>
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-buttons">
                    <button class="new-chat-btn" id="newChatBtn" type="button">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span data-i18n="btn_new_chat">New Chat</span>
                    </button>
                    <button class="temp-chat-btn" id="tempChatBtn" type="button" title="Temporary Chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            <line x1="9" y1="10" x2="15" y2="10"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="sessions-list" id="sessionsList"></div>
            <div class="sidebar-footer">
                <div class="lang-switcher">
                    <button class="lang-btn" id="langBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        <span id="currentLangLabel">English</span>
                    </button>
                    <div class="lang-dropdown hidden ui-pop" id="langDropdown">
                        <button class="lang-option" data-lang="en_US">English</button>
                        <button class="lang-option" data-lang="zh_CN">简体中文</button>
                    </div>
                </div>
                <button class="download-btn" id="openDownloadBtn" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span data-i18n="btn_open_download">Download</span>
                </button>
                <button class="settings-btn" id="openSettingsBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span data-i18n="btn_settings">Settings</span>
                </button>
            </div>
        </aside>

        <!-- Mobile sidebar toggle -->
        <button class="sidebar-toggle" id="sidebarToggle" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Model Status Bar -->
            <div class="model-bar" id="modelBar">
                <div class="model-bar-left">
                    <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" type="button" title="Toggle Sidebar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                    </button>
                    <div class="model-status">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="modelStatus" data-i18n="status_no_model">No model loaded</span>
                    </div>
                </div>
                <div class="model-bar-actions">
                    <button class="perf-toggle-btn" id="performancePanelToggleBtn" type="button" title="Performance Panel">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="20" x2="4" y2="10"></line>
                            <line x1="10" y1="20" x2="10" y2="6"></line>
                            <line x1="16" y1="20" x2="16" y2="12"></line>
                            <line x1="22" y1="20" x2="22" y2="4"></line>
                        </svg>
                    </button>
                    <div class="model-switcher" id="modelSwitcher">
                        <button class="model-switcher-btn" id="modelSwitcherBtn" type="button">
                            <span class="model-switcher-name" id="modelSwitcherName" data-i18n="model_switcher_select">Select model</span>
                            <svg class="model-switcher-caret" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 6 8 10 12 6"></polyline>
                            </svg>
                        </button>
                        <div class="model-switcher-menu hidden ui-pop" id="modelSwitcherMenu">
                            <div class="model-switcher-title" data-i18n="label_model">Model</div>
                            <div class="model-switcher-list" id="modelSwitcherList"></div>
                            <button class="model-switcher-manage" id="modelSwitcherManage" type="button" data-i18n="btn_settings">Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="performance-panel ui-panel" id="performancePanel">
                <div class="perf-row perf-top panel-handle" id="performancePanelHandle">
                    <div class="gen-stats" id="genStats">
                        <span class="gen-stat"><span id="genTokens">0</span> tokens</span>
                        <span class="gen-stat-sep">|</span>
                        <span class="gen-stat"><span id="genSpeed">0</span> t/s</span>
                        <span class="gen-stat-sep">|</span>
                        <span class="gen-stat"><span id="genTime">0</span>s</span>
                    </div>
                    <button class="panel-close-btn" id="performancePanelCloseBtn" type="button" title="Hide">x</button>
                </div>
                <div class="perf-row perf-middle">
                    <div class="status-pill" id="memoryStatus" data-i18n="status_model_memory">Model Mem</div>
                    <div class="status-pill status-pill-download" id="downloadStatusBadge" data-i18n="status_download">Download</div>
                </div>
                <div class="perf-row perf-bottom">
                    <button class="npu-monitor-btn" id="npuMonitorBtn" title="NPU Monitor">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        <span id="npuUtilText">--</span>
                    </button>
                </div>
            </div>

            <!-- NPU Monitor Panel -->
            <div class="npu-monitor-panel hidden ui-panel" id="npuMonitorPanel">
                <div class="npu-monitor-header panel-handle" id="npuMonitorHeader">
                    <span data-i18n="npu_monitor_title">NPU Monitor</span>
                    <button class="close-btn" id="closeNpuMonitorBtn">&times;</button>
                </div>
                <div class="npu-monitor-content">
                    <div class="npu-current">
                        <span data-i18n="npu_utilization">Utilization</span>: <span id="npuCurrentValue">0</span>%
                    </div>
                    <canvas id="npuChart" width="400" height="150"></canvas>
                    <div class="npu-status" id="npuStatus"></div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 data-i18n="app_title">Idle NPU Waker</h1>
                    <p data-i18n="tip_start_chatting">Start chatting to begin</p>
                </div>
                <div class="messages" id="messages"></div>
            </div>

            <button class="scroll-bottom-btn" id="scrollBottomBtn" type="button" title="Back to bottom" aria-label="Back to bottom">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <polyline points="6 13 12 19 18 13"></polyline>
                </svg>
            </button>

            <!-- Input Area -->
            <div class="input-area">
                <div class="attachments-bar hidden" id="attachmentsBar">
                    <span class="attachments-label" data-i18n="label_attachments">Attachments</span>
                    <div class="attachments-list" id="attachmentsList"></div>
                </div>
                <div class="input-container">
                    <textarea
                        id="messageInput"
                        data-i18n-placeholder="input_placeholder"
                        placeholder="Send a message..."
                        rows="1"
                        disabled
                    ></textarea>
                    <button class="attach-btn" id="attachBtn" title="Attach">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.5V8a5 5 0 0 0-10 0v9a3 3 0 0 0 6 0V9"></path>
                            <path d="M16 12v5a4 4 0 0 1-8 0V7a6 6 0 0 1 12 0v5"></path>
                        </svg>
                    </button>
                    <button class="send-btn" id="sendBtn" disabled title="Send">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button class="stop-btn hidden" id="stopBtn" title="Stop">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                        </svg>
                    </button>
                </div>
                <input type="file" id="fileInput" class="hidden" multiple>
            </div>
        </main>
    </div>

    <div class="welcome-overlay hidden" id="welcomeOverlay">
        <div class="welcome-card">
            <h1 data-i18n="app_title">Idle NPU Waker</h1>
            <p data-i18n="tip_load_model_first">Please load a model first</p>
            <div class="welcome-form">
                <div class="setting-group" id="welcomeLocalModelGroup">
                    <label data-i18n="label_model">Local Model</label>
                    <select id="welcomeLocalModelSelect">
                        <option value="" data-i18n="opt_select_model">-- Select a model --</option>
                    </select>
                    <button class="refresh-btn" id="welcomeRefreshModelsBtn" type="button" data-i18n="btn_refresh">Refresh</button>
                </div>
                <div class="setting-group">
                    <label data-i18n="label_device">Device</label>
                    <select id="welcomeDeviceSelect">
                        <option value="AUTO">AUTO</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label><span data-i18n="conf_max_prompt_len">Max Prompt Length</span>: <span id="welcomeMaxPromptLenValue">16384</span></label>
                    <input type="range" id="welcomeMaxPromptLen" min="1024" max="32768" step="1024" value="16384">
                </div>
            </div>
            <div class="welcome-actions">
                <button class="secondary-btn welcome-download-btn" id="welcomeDownloadBtn" type="button" data-i18n="btn_open_download">Download</button>
                <button class="primary-btn welcome-load-btn" id="welcomeLoadBtn" type="button" data-i18n="btn_load_model">Load Model</button>
            </div>
            <p class="welcome-hint" id="welcomeSlowHint" data-i18n="tip_first_load_slow">First load may take a while.</p>
            <div class="welcome-loading hidden" id="welcomeLoading">
                <div class="welcome-loading-bar">
                    <div class="welcome-loading-bar-inner"></div>
                </div>
                <span id="welcomeLoadingText">Loading...</span>
                <span id="welcomeAppMemory">App Mem --</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay hidden ui-modal" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="btn_settings">Settings</h2>
                <button class="close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="modal-content settings-modal-content">
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="model" data-i18n="tab_model">Model</button>
                    <button class="tab-btn" data-tab="generation" data-i18n="grp_generation">Generation</button>
                    <button class="tab-btn" data-tab="context" data-i18n="grp_context">Context</button>
                </div>
                <div class="settings-tab-body">
                    <div class="tab-content active" id="tab-model">
                        <div class="setting-group checkbox-group">
                            <label>
                                <input type="checkbox" id="autoLoadModelToggle">
                                <span data-i18n="conf_auto_load_model">Auto-load last model on startup</span>
                            </label>
                        </div>
                        <div class="setting-group" id="localModelGroup">
                            <label data-i18n="label_model">Local Model</label>
                            <select id="localModelSelect">
                                <option value="" data-i18n="opt_select_model">-- Select a model --</option>
                            </select>
                            <button class="refresh-btn" id="refreshModelsBtn" data-i18n="btn_refresh">Refresh</button>
                        </div>
                        <div class="setting-group">
                            <label data-i18n="label_device">Device</label>
                            <select id="deviceSelect">
                                <option value="AUTO">AUTO</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label><span data-i18n="conf_npu_poll_interval">NPU Poll Interval</span>: <span id="npuPollIntervalValue">1000</span> ms</label>
                            <input type="range" id="npuPollInterval" min="200" max="5000" step="100" value="1000">
                        </div>
                        <div class="setting-group">
                            <label><span data-i18n="conf_max_prompt_len">Max Prompt Length</span>: <span id="maxPromptLenValue">16384</span></label>
                            <input type="range" id="maxPromptLen" min="1024" max="32768" step="1024" value="16384">
                        </div>
                        <button class="primary-btn" id="loadModelConfirmBtn" data-i18n="btn_load_model">Load Model</button>
                    </div>

                    <div class="tab-content" id="tab-generation">
                        <div class="setting-group" data-setting-key="max_new_tokens">
                            <label><span data-i18n="conf_max_tokens">Max Tokens</span>: <span id="maxTokensValue">1024</span></label>
                            <input type="range" id="maxTokens" min="128" max="8192" step="128" value="1024">
                        </div>
                        <div class="setting-group" data-setting-key="temperature">
                            <label><span data-i18n="conf_temp">Temperature</span>: <span id="temperatureValue">0.7</span></label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                        </div>
                        <div class="setting-group" data-setting-key="top_p">
                            <label><span data-i18n="conf_top_p">Top P</span>: <span id="topPValue">0.9</span></label>
                            <input type="range" id="topP" min="0" max="1" step="0.05" value="0.9">
                        </div>
                        <div class="setting-group" data-setting-key="top_k">
                            <label><span data-i18n="conf_top_k">Top K</span>: <span id="topKValue">40</span></label>
                            <input type="number" id="topK" min="1" max="100" value="40">
                        </div>
                        <div class="setting-group" data-setting-key="repetition_penalty">
                            <label><span data-i18n="conf_rep_penalty">Repetition Penalty</span>: <span id="repPenaltyValue">1.1</span></label>
                            <input type="range" id="repPenalty" min="1" max="2" step="0.1" value="1.1">
                        </div>
                        <div class="setting-group checkbox-group" data-setting-key="do_sample">
                            <label>
                                <input type="checkbox" id="doSample" checked>
                                <span data-i18n="conf_do_sample">Enable Sampling</span>
                            </label>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-context">
                        <div class="setting-group" data-setting-key="max_history_turns">
                            <label><span data-i18n="conf_history_turns">Max History Turns</span>: <span id="historyTurnsValue">10</span></label>
                            <input type="range" id="historyTurns" min="0" max="50" step="1" value="10">
                        </div>
                        <div class="setting-group" data-setting-key="system_prompt">
                            <label data-i18n="conf_sys_prompt">System Prompt</label>
                            <textarea id="systemPrompt" rows="4">You are a helpful AI assistant.</textarea>
                        </div>
                        <div class="setting-group checkbox-group" data-setting-key="enable_thinking">
                            <label>
                                <input type="checkbox" id="enableThinking" checked>
                                <span data-i18n="conf_enable_thinking">Enable Thinking</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal-overlay hidden ui-modal" id="downloadModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="group_download">Download Model (ModelScope)</h2>
                <button class="close-btn" id="closeDownloadBtn" type="button">&times;</button>
            </div>
            <div class="modal-content">
                <div class="download-catalog">
                    <div class="download-catalog-header">
                        <div class="download-catalog-title" data-i18n="download_catalog_title">NPU Optimized Models</div>
                        <div class="download-catalog-actions">
                            <input
                                type="text"
                                id="downloadSearchInput"
                                class="download-search"
                                data-i18n-placeholder="download_search_placeholder"
                                placeholder="Search model name or ID..."
                            >
                            <a
                                class="download-collection-link"
                                id="downloadCollectionLink"
                                href="https://www.modelscope.cn/collections/LLMs-optimized-for-NPU-13ad4be17f8740"
                                target="_blank"
                                rel="noopener"
                                data-i18n="download_open_collection"
                            >View Collection</a>
                        </div>
                    </div>
                    <div class="download-cards" id="downloadCards"></div>
                    <div class="download-cards-empty hidden" id="downloadCardsEmpty" data-i18n="download_card_empty">No models found</div>
                </div>
                <div class="download-divider"></div>
                <div class="setting-group">
                    <label data-i18n="label_download_model">Model ID</label>
                    <input
                        type="text"
                        id="downloadModelInput"
                        list="downloadModelList"
                        data-i18n-placeholder="placeholder_repo"
                        placeholder="Select or Enter Model ID..."
                    >
                    <datalist id="downloadModelList"></datalist>
                </div>
                <div class="download-actions">
                    <button class="primary-btn" id="downloadModelBtn" type="button" data-i18n="btn_download">Download</button>
                </div>
                <div class="download-progress hidden" id="downloadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="downloadStatus" data-i18n="status_downloading">Downloading...</span>
                    <button class="cancel-btn" id="cancelDownloadBtn" type="button" data-i18n="btn_cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay hidden ui-modal" id="renameModal">
        <div class="modal small-modal">
            <div class="modal-header">
                <h2 data-i18n="dialog_rename_title">Rename Chat</h2>
                <button class="close-btn" id="closeRenameBtn">&times;</button>
            </div>
            <div class="modal-content">
                <input type="text" id="renameInput" data-i18n-placeholder="dialog_rename_msg" placeholder="Enter new name">
                <div class="modal-actions">
                    <button class="secondary-btn" id="cancelRenameBtn" data-i18n="btn_cancel">Cancel</button>
                    <button class="primary-btn" id="confirmRenameBtn" data-i18n="menu_rename_chat">Rename</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast hidden" id="toast"></div>

    <script src="/static/vendor/marked.min.js?v=0.2.0-alpha"></script>
    <script src="/static/vendor/mermaid.min.js?v=0.2.0-alpha"></script>
    <script src="/static/vendor/highlightjs/highlight.min.js?v=0.2.0-alpha"></script>
    <script src="/static/vendor/katex.min.js?v=0.2.0-alpha"></script>
    <script src="/static/vendor/auto-render.min.js?v=0.2.0-alpha"></script>
    <script src="/static/app.js?v=0.2.0-alpha"></script>
</body>
</html>
